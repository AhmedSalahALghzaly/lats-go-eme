{"dependencies":[{"name":"../../utils/rx","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":6,"column":10,"index":183},"end":{"line":6,"column":35,"index":208}}],"key":"sChOlheQ5HGfniz0xsfJTJwC0UM=","exportNames":["*"],"imports":1}},{"name":"../../utils/common","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":7,"column":14,"index":224},"end":{"line":7,"column":43,"index":253}}],"key":"f8rxJKsVH8u9Uvy41cjr6BETN6o=","exportNames":["*"],"imports":1}},{"name":"../../utils/fp/Result","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":8,"column":14,"index":269},"end":{"line":8,"column":46,"index":301}}],"key":"Di9tD1pQ8QBhc+ulCznI4W6MXnM=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  exports.__esModule = true;\n  exports.default = subscribeToCount;\n  exports.experimentalDisableObserveCountThrottling = experimentalDisableObserveCountThrottling;\n  var _rx = require(_dependencyMap[0], \"../../utils/rx\");\n  var _common = require(_dependencyMap[1], \"../../utils/common\");\n  var _Result = require(_dependencyMap[2], \"../../utils/fp/Result\");\n  var isThrottlingDisabled = false;\n  function experimentalDisableObserveCountThrottling() {\n    isThrottlingDisabled = true;\n  }\n\n  // Produces an observable version of a query count by re-querying the database\n  // when any change occurs in any of the relevant Stores.\n  //\n  // TODO: Potential optimizations:\n  // - increment/decrement counter using matchers on insert/delete\n\n  function observeCountThrottled(query) {\n    var {\n      collection: collection\n    } = query;\n    return collection.database.withChangesForTables(query.allTables).pipe((0, _rx.throttleTime)(250),\n    // Note: this has a bug, but we'll delete it anyway\n    (0, _rx.switchMap)(function () {\n      return (0, _Result.toPromise)(function (callback) {\n        return collection._fetchCount(query, callback);\n      });\n    }), (0, _rx.distinctUntilChanged)());\n  }\n  function subscribeToCount(query, isThrottled, subscriber) {\n    if (isThrottled && !isThrottlingDisabled) {\n      var observable = observeCountThrottled(query);\n      var subscription = observable.subscribe(subscriber);\n      return function () {\n        return subscription.unsubscribe();\n      };\n    }\n    var {\n      collection: collection\n    } = query;\n    var unsubscribed = false;\n    var previousCount = -1;\n    var observeCountFetch = function () {\n      collection._fetchCount(query, function (result) {\n        if (result.error) {\n          (0, _common.logError)(result.error.toString());\n          return;\n        }\n        var count = result.value;\n        var shouldEmit = count !== previousCount && !unsubscribed;\n        previousCount = count;\n        shouldEmit && subscriber(count);\n      });\n    };\n    var unsubscribe = collection.database.experimentalSubscribe(query.allTables, observeCountFetch, {\n      name: 'subscribeToCount',\n      query: query,\n      subscriber: subscriber\n    });\n    observeCountFetch();\n    return function () {\n      unsubscribed = true;\n      unsubscribe();\n    };\n  }\n});","lineCount":69,"map":[[2,2,1,0],[2,14,1,12],[4,2,3,0,"exports"],[4,9,3,7],[4,10,3,8,"__esModule"],[4,20,3,18],[4,23,3,21],[4,27,3,25],[5,2,4,0,"exports"],[5,9,4,7],[5,10,4,8,"default"],[5,17,4,15],[5,20,4,18,"subscribeToCount"],[5,36,4,34],[6,2,5,0,"exports"],[6,9,5,7],[6,10,5,8,"experimentalDisableObserveCountThrottling"],[6,51,5,49],[6,54,5,52,"experimentalDisableObserveCountThrottling"],[6,95,5,93],[7,2,6,0],[7,6,6,4,"_rx"],[7,9,6,7],[7,12,6,10,"require"],[7,19,6,17],[7,20,6,17,"_dependencyMap"],[7,34,6,17],[7,55,6,34],[7,56,6,35],[8,2,7,0],[8,6,7,4,"_common"],[8,13,7,11],[8,16,7,14,"require"],[8,23,7,21],[8,24,7,21,"_dependencyMap"],[8,38,7,21],[8,63,7,42],[8,64,7,43],[9,2,8,0],[9,6,8,4,"_Result"],[9,13,8,11],[9,16,8,14,"require"],[9,23,8,21],[9,24,8,21,"_dependencyMap"],[9,38,8,21],[9,66,8,45],[9,67,8,46],[10,2,9,0],[10,6,9,4,"isThrottlingDisabled"],[10,26,9,24],[10,29,9,27],[10,34,9,32],[11,2,10,0],[11,11,10,9,"experimentalDisableObserveCountThrottling"],[11,52,10,50,"experimentalDisableObserveCountThrottling"],[11,53,10,50],[11,55,10,53],[12,4,11,2,"isThrottlingDisabled"],[12,24,11,22],[12,27,11,25],[12,31,11,29],[13,2,12,0],[15,2,14,0],[16,2,15,0],[17,2,16,0],[18,2,17,0],[19,2,18,0],[21,2,20,0],[21,11,20,9,"observeCountThrottled"],[21,32,20,30,"observeCountThrottled"],[21,33,20,31,"query"],[21,38,20,36],[21,40,20,38],[22,4,21,2],[22,8,21,6],[23,6,22,4,"collection"],[23,16,22,14],[23,18,22,16,"collection"],[24,4,23,2],[24,5,23,3],[24,8,23,6,"query"],[24,13,23,11],[25,4,24,2],[25,11,24,9,"collection"],[25,21,24,19],[25,22,24,20,"database"],[25,30,24,28],[25,31,24,29,"withChangesForTables"],[25,51,24,49],[25,52,24,50,"query"],[25,57,24,55],[25,58,24,56,"allTables"],[25,67,24,65],[25,68,24,66],[25,69,24,67,"pipe"],[25,73,24,71],[25,74,24,72],[25,75,24,73],[25,76,24,74],[25,78,24,76,"_rx"],[25,81,24,79],[25,82,24,80,"throttleTime"],[25,94,24,92],[25,96,24,94],[25,99,24,97],[25,100,24,98],[26,4,25,2],[27,4,26,2],[27,5,26,3],[27,6,26,4],[27,8,26,6,"_rx"],[27,11,26,9],[27,12,26,10,"switchMap"],[27,21,26,19],[27,23,26,21],[27,35,26,33],[28,6,27,4],[28,13,27,11],[28,14,27,12],[28,15,27,13],[28,17,27,15,"_Result"],[28,24,27,22],[28,25,27,23,"toPromise"],[28,34,27,32],[28,36,27,34],[28,46,27,44,"callback"],[28,54,27,52],[28,56,27,54],[29,8,28,6],[29,15,28,13,"collection"],[29,25,28,23],[29,26,28,24,"_fetchCount"],[29,37,28,35],[29,38,28,36,"query"],[29,43,28,41],[29,45,28,43,"callback"],[29,53,28,51],[29,54,28,52],[30,6,29,4],[30,7,29,5],[30,8,29,6],[31,4,30,2],[31,5,30,3],[31,6,30,4],[31,8,30,6],[31,9,30,7],[31,10,30,8],[31,12,30,10,"_rx"],[31,15,30,13],[31,16,30,14,"distinctUntilChanged"],[31,36,30,34],[31,38,30,36],[31,39,30,37],[31,40,30,38],[32,2,31,0],[33,2,32,0],[33,11,32,9,"subscribeToCount"],[33,27,32,25,"subscribeToCount"],[33,28,32,26,"query"],[33,33,32,31],[33,35,32,33,"isThrottled"],[33,46,32,44],[33,48,32,46,"subscriber"],[33,58,32,56],[33,60,32,58],[34,4,33,2],[34,8,33,6,"isThrottled"],[34,19,33,17],[34,23,33,21],[34,24,33,22,"isThrottlingDisabled"],[34,44,33,42],[34,46,33,44],[35,6,34,4],[35,10,34,8,"observable"],[35,20,34,18],[35,23,34,21,"observeCountThrottled"],[35,44,34,42],[35,45,34,43,"query"],[35,50,34,48],[35,51,34,49],[36,6,35,4],[36,10,35,8,"subscription"],[36,22,35,20],[36,25,35,23,"observable"],[36,35,35,33],[36,36,35,34,"subscribe"],[36,45,35,43],[36,46,35,44,"subscriber"],[36,56,35,54],[36,57,35,55],[37,6,36,4],[37,13,36,11],[37,25,36,23],[38,8,37,6],[38,15,37,13,"subscription"],[38,27,37,25],[38,28,37,26,"unsubscribe"],[38,39,37,37],[38,40,37,38],[38,41,37,39],[39,6,38,4],[39,7,38,5],[40,4,39,2],[41,4,40,2],[41,8,40,6],[42,6,41,4,"collection"],[42,16,41,14],[42,18,41,16,"collection"],[43,4,42,2],[43,5,42,3],[43,8,42,6,"query"],[43,13,42,11],[44,4,43,2],[44,8,43,6,"unsubscribed"],[44,20,43,18],[44,23,43,21],[44,28,43,26],[45,4,44,2],[45,8,44,6,"previousCount"],[45,21,44,19],[45,24,44,22],[45,25,44,23],[45,26,44,24],[46,4,45,2],[46,8,45,6,"observeCountFetch"],[46,25,45,23],[46,28,45,26],[46,37,45,26,"observeCountFetch"],[46,38,45,26],[46,40,45,38],[47,6,46,4,"collection"],[47,16,46,14],[47,17,46,15,"_fetchCount"],[47,28,46,26],[47,29,46,27,"query"],[47,34,46,32],[47,36,46,34],[47,46,46,44,"result"],[47,52,46,50],[47,54,46,52],[48,8,47,6],[48,12,47,10,"result"],[48,18,47,16],[48,19,47,17,"error"],[48,24,47,22],[48,26,47,24],[49,10,48,8],[49,11,48,9],[49,12,48,10],[49,14,48,12,"_common"],[49,21,48,19],[49,22,48,20,"logError"],[49,30,48,28],[49,32,48,30,"result"],[49,38,48,36],[49,39,48,37,"error"],[49,44,48,42],[49,45,48,43,"toString"],[49,53,48,51],[49,54,48,52],[49,55,48,53],[49,56,48,54],[50,10,49,8],[51,8,50,6],[52,8,51,6],[52,12,51,10,"count"],[52,17,51,15],[52,20,51,18,"result"],[52,26,51,24],[52,27,51,25,"value"],[52,32,51,30],[53,8,52,6],[53,12,52,10,"shouldEmit"],[53,22,52,20],[53,25,52,23,"count"],[53,30,52,28],[53,35,52,33,"previousCount"],[53,48,52,46],[53,52,52,50],[53,53,52,51,"unsubscribed"],[53,65,52,63],[54,8,53,6,"previousCount"],[54,21,53,19],[54,24,53,22,"count"],[54,29,53,27],[55,8,54,6,"shouldEmit"],[55,18,54,16],[55,22,54,20,"subscriber"],[55,32,54,30],[55,33,54,31,"count"],[55,38,54,36],[55,39,54,37],[56,6,55,4],[56,7,55,5],[56,8,55,6],[57,4,56,2],[57,5,56,3],[58,4,57,2],[58,8,57,6,"unsubscribe"],[58,19,57,17],[58,22,57,20,"collection"],[58,32,57,30],[58,33,57,31,"database"],[58,41,57,39],[58,42,57,40,"experimentalSubscribe"],[58,63,57,61],[58,64,57,62,"query"],[58,69,57,67],[58,70,57,68,"allTables"],[58,79,57,77],[58,81,57,79,"observeCountFetch"],[58,98,57,96],[58,100,57,98],[59,6,58,4,"name"],[59,10,58,8],[59,12,58,10],[59,30,58,28],[60,6,59,4,"query"],[60,11,59,9],[60,13,59,11,"query"],[60,18,59,16],[61,6,60,4,"subscriber"],[61,16,60,14],[61,18,60,16,"subscriber"],[62,4,61,2],[62,5,61,3],[62,6,61,4],[63,4,62,2,"observeCountFetch"],[63,21,62,19],[63,22,62,20],[63,23,62,21],[64,4,63,2],[64,11,63,9],[64,23,63,21],[65,6,64,4,"unsubscribed"],[65,18,64,16],[65,21,64,19],[65,25,64,23],[66,6,65,4,"unsubscribe"],[66,17,65,15],[66,18,65,16],[66,19,65,17],[67,4,66,2],[67,5,66,3],[68,2,67,0],[69,0,67,1],[69,3]],"functionMap":{"names":["<global>","experimentalDisableObserveCountThrottling","observeCountThrottled","<anonymous>","subscribeToCount","observeCountFetch","collection._fetchCount$argument_1"],"mappings":"AAA;ACS;CDE;AEQ;qBCM;GDI;CFC;AIC;WDI;KCE;0BCO;kCCC;KDS;GDC;SDO;GCG"},"hasCjsExports":true},"type":"js/module"}]}