{"dependencies":[{"name":"../../utils/rx","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":6,"column":10,"index":183},"end":{"line":6,"column":35,"index":208}}],"key":"sChOlheQ5HGfniz0xsfJTJwC0UM=","exportNames":["*"],"imports":1}},{"name":"../../utils/common","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":7,"column":14,"index":224},"end":{"line":7,"column":43,"index":253}}],"key":"f8rxJKsVH8u9Uvy41cjr6BETN6o=","exportNames":["*"],"imports":1}},{"name":"../../utils/fp/Result","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":8,"column":14,"index":269},"end":{"line":8,"column":46,"index":301}}],"key":"Di9tD1pQ8QBhc+ulCznI4W6MXnM=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  exports.__esModule = true;\n  exports.default = subscribeToCount;\n  exports.experimentalDisableObserveCountThrottling = experimentalDisableObserveCountThrottling;\n  var _rx = require(_dependencyMap[0], \"../../utils/rx\");\n  var _common = require(_dependencyMap[1], \"../../utils/common\");\n  var _Result = require(_dependencyMap[2], \"../../utils/fp/Result\");\n  var isThrottlingDisabled = false;\n  function experimentalDisableObserveCountThrottling() {\n    isThrottlingDisabled = true;\n  }\n\n  // Produces an observable version of a query count by re-querying the database\n  // when any change occurs in any of the relevant Stores.\n  //\n  // TODO: Potential optimizations:\n  // - increment/decrement counter using matchers on insert/delete\n\n  function observeCountThrottled(query) {\n    var collection = query.collection;\n    return collection.database.withChangesForTables(query.allTables).pipe((0, _rx.throttleTime)(250),\n    // Note: this has a bug, but we'll delete it anyway\n    (0, _rx.switchMap)(function () {\n      return (0, _Result.toPromise)(function (callback) {\n        return collection._fetchCount(query, callback);\n      });\n    }), (0, _rx.distinctUntilChanged)());\n  }\n  function subscribeToCount(query, isThrottled, subscriber) {\n    if (isThrottled && !isThrottlingDisabled) {\n      var observable = observeCountThrottled(query);\n      var subscription = observable.subscribe(subscriber);\n      return function () {\n        return subscription.unsubscribe();\n      };\n    }\n    var collection = query.collection;\n    var unsubscribed = false;\n    var previousCount = -1;\n    var observeCountFetch = function () {\n      collection._fetchCount(query, function (result) {\n        if (result.error) {\n          (0, _common.logError)(result.error.toString());\n          return;\n        }\n        var count = result.value;\n        var shouldEmit = count !== previousCount && !unsubscribed;\n        previousCount = count;\n        shouldEmit && subscriber(count);\n      });\n    };\n    var unsubscribe = collection.database.experimentalSubscribe(query.allTables, observeCountFetch, {\n      name: 'subscribeToCount',\n      query: query,\n      subscriber: subscriber\n    });\n    observeCountFetch();\n    return function () {\n      unsubscribed = true;\n      unsubscribe();\n    };\n  }\n});","lineCount":65,"map":[[2,2,1,0],[2,14,1,12],[4,2,3,0,"exports"],[4,9,3,7],[4,10,3,8,"__esModule"],[4,20,3,18],[4,23,3,21],[4,27,3,25],[5,2,4,0,"exports"],[5,9,4,7],[5,10,4,8,"default"],[5,17,4,15],[5,20,4,18,"subscribeToCount"],[5,36,4,34],[6,2,5,0,"exports"],[6,9,5,7],[6,10,5,8,"experimentalDisableObserveCountThrottling"],[6,51,5,49],[6,54,5,52,"experimentalDisableObserveCountThrottling"],[6,95,5,93],[7,2,6,0],[7,6,6,4,"_rx"],[7,9,6,7],[7,12,6,10,"require"],[7,19,6,17],[7,20,6,17,"_dependencyMap"],[7,34,6,17],[7,55,6,34],[7,56,6,35],[8,2,7,0],[8,6,7,4,"_common"],[8,13,7,11],[8,16,7,14,"require"],[8,23,7,21],[8,24,7,21,"_dependencyMap"],[8,38,7,21],[8,63,7,42],[8,64,7,43],[9,2,8,0],[9,6,8,4,"_Result"],[9,13,8,11],[9,16,8,14,"require"],[9,23,8,21],[9,24,8,21,"_dependencyMap"],[9,38,8,21],[9,66,8,45],[9,67,8,46],[10,2,9,0],[10,6,9,4,"isThrottlingDisabled"],[10,26,9,24],[10,29,9,27],[10,34,9,32],[11,2,10,0],[11,11,10,9,"experimentalDisableObserveCountThrottling"],[11,52,10,50,"experimentalDisableObserveCountThrottling"],[11,53,10,50],[11,55,10,53],[12,4,11,2,"isThrottlingDisabled"],[12,24,11,22],[12,27,11,25],[12,31,11,29],[13,2,12,0],[15,2,14,0],[16,2,15,0],[17,2,16,0],[18,2,17,0],[19,2,18,0],[21,2,20,0],[21,11,20,9,"observeCountThrottled"],[21,32,20,30,"observeCountThrottled"],[21,33,20,31,"query"],[21,38,20,36],[21,40,20,38],[22,4,21,2],[22,8,22,16,"collection"],[22,18,22,26],[22,21,23,6,"query"],[22,26,23,11],[22,27,22,4,"collection"],[22,37,22,14],[23,4,24,2],[23,11,24,9,"collection"],[23,21,24,19],[23,22,24,20,"database"],[23,30,24,28],[23,31,24,29,"withChangesForTables"],[23,51,24,49],[23,52,24,50,"query"],[23,57,24,55],[23,58,24,56,"allTables"],[23,67,24,65],[23,68,24,66],[23,69,24,67,"pipe"],[23,73,24,71],[23,74,24,72],[23,75,24,73],[23,76,24,74],[23,78,24,76,"_rx"],[23,81,24,79],[23,82,24,80,"throttleTime"],[23,94,24,92],[23,96,24,94],[23,99,24,97],[23,100,24,98],[24,4,25,2],[25,4,26,2],[25,5,26,3],[25,6,26,4],[25,8,26,6,"_rx"],[25,11,26,9],[25,12,26,10,"switchMap"],[25,21,26,19],[25,23,26,21],[25,35,26,33],[26,6,27,4],[26,13,27,11],[26,14,27,12],[26,15,27,13],[26,17,27,15,"_Result"],[26,24,27,22],[26,25,27,23,"toPromise"],[26,34,27,32],[26,36,27,34],[26,46,27,44,"callback"],[26,54,27,52],[26,56,27,54],[27,8,28,6],[27,15,28,13,"collection"],[27,25,28,23],[27,26,28,24,"_fetchCount"],[27,37,28,35],[27,38,28,36,"query"],[27,43,28,41],[27,45,28,43,"callback"],[27,53,28,51],[27,54,28,52],[28,6,29,4],[28,7,29,5],[28,8,29,6],[29,4,30,2],[29,5,30,3],[29,6,30,4],[29,8,30,6],[29,9,30,7],[29,10,30,8],[29,12,30,10,"_rx"],[29,15,30,13],[29,16,30,14,"distinctUntilChanged"],[29,36,30,34],[29,38,30,36],[29,39,30,37],[29,40,30,38],[30,2,31,0],[31,2,32,0],[31,11,32,9,"subscribeToCount"],[31,27,32,25,"subscribeToCount"],[31,28,32,26,"query"],[31,33,32,31],[31,35,32,33,"isThrottled"],[31,46,32,44],[31,48,32,46,"subscriber"],[31,58,32,56],[31,60,32,58],[32,4,33,2],[32,8,33,6,"isThrottled"],[32,19,33,17],[32,23,33,21],[32,24,33,22,"isThrottlingDisabled"],[32,44,33,42],[32,46,33,44],[33,6,34,4],[33,10,34,8,"observable"],[33,20,34,18],[33,23,34,21,"observeCountThrottled"],[33,44,34,42],[33,45,34,43,"query"],[33,50,34,48],[33,51,34,49],[34,6,35,4],[34,10,35,8,"subscription"],[34,22,35,20],[34,25,35,23,"observable"],[34,35,35,33],[34,36,35,34,"subscribe"],[34,45,35,43],[34,46,35,44,"subscriber"],[34,56,35,54],[34,57,35,55],[35,6,36,4],[35,13,36,11],[35,25,36,23],[36,8,37,6],[36,15,37,13,"subscription"],[36,27,37,25],[36,28,37,26,"unsubscribe"],[36,39,37,37],[36,40,37,38],[36,41,37,39],[37,6,38,4],[37,7,38,5],[38,4,39,2],[39,4,40,2],[39,8,41,16,"collection"],[39,18,41,26],[39,21,42,6,"query"],[39,26,42,11],[39,27,41,4,"collection"],[39,37,41,14],[40,4,43,2],[40,8,43,6,"unsubscribed"],[40,20,43,18],[40,23,43,21],[40,28,43,26],[41,4,44,2],[41,8,44,6,"previousCount"],[41,21,44,19],[41,24,44,22],[41,25,44,23],[41,26,44,24],[42,4,45,2],[42,8,45,6,"observeCountFetch"],[42,25,45,23],[42,28,45,26],[42,37,45,26,"observeCountFetch"],[42,38,45,26],[42,40,45,38],[43,6,46,4,"collection"],[43,16,46,14],[43,17,46,15,"_fetchCount"],[43,28,46,26],[43,29,46,27,"query"],[43,34,46,32],[43,36,46,34],[43,46,46,44,"result"],[43,52,46,50],[43,54,46,52],[44,8,47,6],[44,12,47,10,"result"],[44,18,47,16],[44,19,47,17,"error"],[44,24,47,22],[44,26,47,24],[45,10,48,8],[45,11,48,9],[45,12,48,10],[45,14,48,12,"_common"],[45,21,48,19],[45,22,48,20,"logError"],[45,30,48,28],[45,32,48,30,"result"],[45,38,48,36],[45,39,48,37,"error"],[45,44,48,42],[45,45,48,43,"toString"],[45,53,48,51],[45,54,48,52],[45,55,48,53],[45,56,48,54],[46,10,49,8],[47,8,50,6],[48,8,51,6],[48,12,51,10,"count"],[48,17,51,15],[48,20,51,18,"result"],[48,26,51,24],[48,27,51,25,"value"],[48,32,51,30],[49,8,52,6],[49,12,52,10,"shouldEmit"],[49,22,52,20],[49,25,52,23,"count"],[49,30,52,28],[49,35,52,33,"previousCount"],[49,48,52,46],[49,52,52,50],[49,53,52,51,"unsubscribed"],[49,65,52,63],[50,8,53,6,"previousCount"],[50,21,53,19],[50,24,53,22,"count"],[50,29,53,27],[51,8,54,6,"shouldEmit"],[51,18,54,16],[51,22,54,20,"subscriber"],[51,32,54,30],[51,33,54,31,"count"],[51,38,54,36],[51,39,54,37],[52,6,55,4],[52,7,55,5],[52,8,55,6],[53,4,56,2],[53,5,56,3],[54,4,57,2],[54,8,57,6,"unsubscribe"],[54,19,57,17],[54,22,57,20,"collection"],[54,32,57,30],[54,33,57,31,"database"],[54,41,57,39],[54,42,57,40,"experimentalSubscribe"],[54,63,57,61],[54,64,57,62,"query"],[54,69,57,67],[54,70,57,68,"allTables"],[54,79,57,77],[54,81,57,79,"observeCountFetch"],[54,98,57,96],[54,100,57,98],[55,6,58,4,"name"],[55,10,58,8],[55,12,58,10],[55,30,58,28],[56,6,59,4,"query"],[56,11,59,9],[56,13,59,11,"query"],[56,18,59,16],[57,6,60,4,"subscriber"],[57,16,60,14],[57,18,60,16,"subscriber"],[58,4,61,2],[58,5,61,3],[58,6,61,4],[59,4,62,2,"observeCountFetch"],[59,21,62,19],[59,22,62,20],[59,23,62,21],[60,4,63,2],[60,11,63,9],[60,23,63,21],[61,6,64,4,"unsubscribed"],[61,18,64,16],[61,21,64,19],[61,25,64,23],[62,6,65,4,"unsubscribe"],[62,17,65,15],[62,18,65,16],[62,19,65,17],[63,4,66,2],[63,5,66,3],[64,2,67,0],[65,0,67,1],[65,3]],"functionMap":{"names":["<global>","experimentalDisableObserveCountThrottling","observeCountThrottled","<anonymous>","subscribeToCount","observeCountFetch","collection._fetchCount$argument_1"],"mappings":"AAA;ACS;CDE;AEQ;qBCM;GDI;CFC;AIC;WDI;KCE;0BCO;kCCC;KDS;GDC;SDO;GCG"},"hasCjsExports":true},"type":"js/module"}]}